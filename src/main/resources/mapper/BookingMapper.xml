<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ccbs.careercoachbookingsystem.mapper.BookingMapper">
    
    <resultMap id="BookingResultMap" type="com.ccbs.careercoachbookingsystem.entity.BookingEntity">
        <id property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="bookingUid" column="booking_uid"/>
        <result property="coachName" column="coach_name"/>
        <result property="coachEmail" column="coach_email"/>
        <result property="startTime" column="start_time"/>
        <result property="endTime" column="end_time"/>
        <result property="status" column="status"/>
        <result property="meetingUrl" column="meeting_url"/>
        <result property="cancelUrl" column="cancel_url"/>
        <result property="rawWebhookData" column="raw_webhook_data"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>
    
    <select id="findByUserId" resultMap="BookingResultMap">
        SELECT * FROM booking
        WHERE user_id = #{userId}
        ORDER BY created_at DESC
    </select>
    
    <select id="findById" resultMap="BookingResultMap">
        SELECT * FROM booking
        WHERE id = #{id}
    </select>
    
    <select id="findByBookingUid" resultMap="BookingResultMap">
        SELECT * FROM booking
        WHERE booking_uid = #{bookingUid}
    </select>
    
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO booking (
            user_id, booking_uid, coach_name, coach_email,
            start_time, end_time, status, meeting_url, cancel_url,
            raw_webhook_data, created_at, updated_at
        ) VALUES (
            #{userId}, #{bookingUid}, #{coachName}, #{coachEmail},
            #{startTime}, #{endTime}, #{status}, #{meetingUrl}, #{cancelUrl},
            #{rawWebhookData}, NOW(), NOW()
        )
    </insert>
    
    <update id="update">
        UPDATE booking
        SET user_id = #{userId},
            booking_uid = #{bookingUid},
            coach_name = #{coachName},
            coach_email = #{coachEmail},
            start_time = #{startTime},
            end_time = #{endTime},
            status = #{status},
            meeting_url = #{meetingUrl},
            cancel_url = #{cancelUrl},
            raw_webhook_data = #{rawWebhookData},
            updated_at = NOW()
        WHERE id = #{id}
    </update>
    
</mapper>
